<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>家計支払いリスト</title>

    <!-- PWA / Mobile Web App Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="支払いリスト">
    <meta name="theme-color" content="#ffffff">

    <!-- アイコン用のプレースホルダー（JSがここを書き換えます） -->
    <link id="app-icon" rel="apple-touch-icon" href="">
    <link id="favicon" rel="icon" href="">

    <!-- Web App Manifest (Placeholder) -->
    <link id="manifest" rel="manifest" href='data:application/manifest+json,{"name":"家計支払いリスト","short_name":"支払いリスト","start_url":".","display":"standalone","background_color":"#ffffff","theme_color":"#ffffff","icons":[]}'>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
      body { overscroll-behavior-y: none; }
    </style>

    <!-- Import Map for Modules -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    
    <!-- Babel Standalone for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- ★アイコン生成スクリプト（ここだけでアイコンを管理します）★ -->
    <script>
        (function() {
            // 1. アイコンのデザイン定義 (SVG)
            // ヘッダーと同じWalletアイコン、背景はSlate-800、線は白
            const iconSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512">
                <rect width="512" height="512" fill="#1e293b" rx="100"/>
                <g transform="translate(64, 64) scale(16)" fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/>
                    <path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/>
                    <path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/>
                </g>
            </svg>`.trim();

            // 2. SVGをPNG画像(DataURI)に変換する関数
            function setIcons() {
                const canvas = document.createElement('canvas');
                canvas.width = 512;
                canvas.height = 512;
                const ctx = canvas.getContext('2d');

                const img = new Image();
                // SVGをBase64化して読み込ませる
                const svgData = 'data:image/svg+xml;base64,' + btoa(iconSvg);
                
                img.onload = function() {
                    // キャンバスに描画
                    ctx.drawImage(img, 0, 0);
                    
                    // PNG形式のデータURLを取得
                    const pngUrl = canvas.toDataURL('image/png');

                    // HTMLのタグを更新
                    document.getElementById('app-icon').href = pngUrl;
                    document.getElementById('favicon').href = pngUrl;

                    // マニフェストファイルも更新
                    const manifestLink = document.getElementById('manifest');
                    const manifest = {
                        name: "家計支払いリスト",
                        short_name: "支払いリスト",
                        start_url: ".",
                        display: "standalone",
                        background_color: "#ffffff",
                        theme_color: "#ffffff",
                        icons: [
                            { src: pngUrl, sizes: "192x192", type: "image/png" },
                            { src: pngUrl, sizes: "512x512", type: "image/png" }
                        ]
                    };
                    manifestLink.href = 'data:application/manifest+json,' + encodeURIComponent(JSON.stringify(manifest));
                    
                    console.log("Icon updated to PNG via JS");
                };
                img.src = svgData;
            }

            // 実行
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setIcons);
            } else {
                setIcons();
            }
        })();
    </script>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Wallet, Download, Upload, Plus, Trash2, AlertCircle } from 'lucide-react';

        // --- COMPONENTS ---

        const StatsCard = ({ amount }) => {
          return (
            <div className="bg-white rounded-lg p-2 shadow-sm border border-slate-200 text-center">
              <p className="text-slate-500 text-[10px] font-bold mb-0.5 flex items-center justify-center gap-1">
                <AlertCircle className="w-3 h-3 text-orange-500" />
                もらう金額合計
              </p>
              <div className="text-xl font-extrabold text-slate-800 tracking-tight">
                ¥{amount.toLocaleString()}
              </div>
            </div>
          );
        };

        const TransactionForm = ({ onAdd }) => {
          const [title, setTitle] = useState('');
          const [amount, setAmount] = useState('');

          const handleSubmit = (e) => {
            e.preventDefault();
            if (!title || !amount) return;

            onAdd({
              title,
              personName: '',
              amount: parseInt(amount, 10),
              date: new Date().toISOString().split('T')[0],
              isPaid: false,
            });

            setTitle('');
            setAmount('');
          };

          return (
            <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-2">
              <form onSubmit={handleSubmit} className="flex gap-2 items-center">
                <input
                    type="text"
                    required
                    placeholder="項目名"
                    value={title}
                    onChange={(e) => setTitle(e.target.value)}
                    className="flex-[2] px-3 py-1.5 border border-slate-200 rounded text-sm focus:outline-none focus:border-indigo-500 bg-slate-50"
                />
                <div className="flex-1 relative min-w-[90px]">
                    <span className="absolute left-2 top-1.5 text-slate-400 text-sm">¥</span>
                    <input
                        type="number"
                        required
                        min="1"
                        placeholder="0"
                        value={amount}
                        onChange={(e) => setAmount(e.target.value)}
                        className="w-full pl-5 pr-2 py-1.5 border border-slate-200 rounded text-sm focus:outline-none focus:border-indigo-500 bg-slate-50 font-medium"
                    />
                </div>
                <button
                    type="submit"
                    className="flex-shrink-0 bg-slate-800 hover:bg-slate-700 text-white p-1.5 rounded transition-colors shadow-sm"
                    title="追加"
                >
                    <Plus className="h-5 w-5" />
                </button>
              </form>
            </div>
          );
        };

        const TransactionList = ({ transactions, onDelete, onToggleStatus }) => {
          if (transactions.length === 0) {
            return (
              <div className="text-center py-8 bg-slate-50 rounded-lg border border-dashed border-slate-300">
                <p className="text-xs text-slate-400">データがありません</p>
              </div>
            );
          }

          return (
            <div className="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden divide-y divide-slate-100">
              {transactions.map((transaction) => (
                <div
                  key={transaction.id}
                  className={`flex items-center justify-between px-2 py-1.5 transition-colors ${
                    transaction.isPaid ? 'bg-slate-50' : 'bg-white'
                  }`}
                >
                  <div className="flex items-center gap-2 flex-1 min-w-0">
                    <button
                      onClick={() => onToggleStatus(transaction.id)}
                      className={`flex-shrink-0 w-[80px] py-1 text-[10px] font-bold rounded border transition-all ${
                        transaction.isPaid
                          ? 'bg-slate-200 text-slate-500 border-slate-300'
                          : 'bg-red-50 text-red-600 border-red-200 hover:bg-red-100'
                      }`}
                    >
                      {transaction.isPaid ? '済' : 'もらってない'}
                    </button>
                    
                    <p className={`text-sm font-bold truncate ${transaction.isPaid ? 'text-slate-400' : 'text-slate-800'}`}>
                      {transaction.title}
                    </p>
                  </div>

                  <div className="flex items-center gap-2">
                    <p className={`text-sm font-bold tabular-nums ${transaction.isPaid ? 'text-slate-400' : 'text-slate-900'}`}>
                      ¥{transaction.amount.toLocaleString()}
                    </p>

                    <div className="flex items-center pl-1">
                      <button
                        type="button"
                        onClick={(e) => {
                            e.preventDefault();
                            e.stopPropagation(); 
                            e.nativeEvent.stopImmediatePropagation();
                            onDelete(transaction.id);
                        }}
                        className="relative z-10 p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors cursor-pointer"
                        title="削除"
                      >
                        <Trash2 className="w-4 h-4 pointer-events-none" />
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          );
        };

        // --- MAIN APP ---
        const App = () => {
          const generateId = () => {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
              try { return crypto.randomUUID(); } catch (e) {}
            }
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
          };

          const [transactions, setTransactions] = useState(() => {
            try {
              const saved = localStorage.getItem('payback_transactions');
              return saved ? JSON.parse(saved) : [];
            } catch (e) {
              console.error("Failed to load transactions", e);
              return [];
            }
          });

          const fileInputRef = useRef(null);

          useEffect(() => {
            localStorage.setItem('payback_transactions', JSON.stringify(transactions));
          }, [transactions]);

          const totalUnpaid = useMemo(() => {
            return transactions
              .filter(t => !t.isPaid)
              .reduce((sum, t) => sum + t.amount, 0);
          }, [transactions]);

          const sortedTransactions = useMemo(() => {
            return [...transactions].sort((a, b) => {
              if (a.isPaid !== b.isPaid) {
                return a.isPaid ? 1 : -1;
              }
              return b.createdAt - a.createdAt;
            });
          }, [transactions]);

          const handleAddTransaction = (newTx) => {
            const transaction = {
              ...newTx,
              id: generateId(), 
              createdAt: Date.now(),
            };
            setTransactions((prev) => [transaction, ...prev]);
          };

          const handleDeleteTransaction = (id) => {
            setTransactions((prev) => prev.filter((t) => t.id !== id));
          };

          const handleToggleStatus = (id) => {
            setTransactions((prev) =>
              prev.map((t) => (t.id === id ? { ...t, isPaid: !t.isPaid } : t))
            );
          };

          const handleBackup = () => {
            const dataStr = JSON.stringify(transactions, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `payback_list.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          };

          const handleRestoreClick = () => {
            fileInputRef.current?.click();
          };

          const handleFileChange = (e) => {
            const file = e.target.files?.[0];
            if (!file) return;

            e.target.value = '';
            
            const reader = new FileReader();
            
            reader.onerror = () => {
                alert('ファイルの読み込みに失敗しました。');
            };

            reader.onload = (event) => {
              try {
                const json = event.target?.result;
                if (!json) throw new Error("Empty content");
                const parsed = JSON.parse(json);
                if (!Array.isArray(parsed)) {
                    alert('ファイル形式が正しくありません。');
                    return;
                }
                const restoredData = parsed
                    .map((item) => ({
                        id: item.id || generateId(),
                        title: item.title || '無題',
                        amount: parseInt(item.amount, 10) || 0,
                        personName: item.personName || '',
                        date: item.date || new Date().toISOString().split('T')[0],
                        isPaid: !!item.isPaid,
                        createdAt: item.createdAt || Date.now(),
                    }))
                    .filter((t) => t.amount > 0 || t.title !== '無題');

                if (restoredData.length === 0) {
                    alert('有効なデータが見つかりませんでした。');
                    return;
                }
                setTransactions(restoredData);
                alert(`${restoredData.length}件のリストを復元しました。`);

              } catch (error) {
                console.error("Restore failed", error);
                alert('ファイルを解析できませんでした。');
              }
            };
            reader.readAsText(file);
          };

          return (
            <div className="min-h-screen bg-gray-50 font-sans text-slate-900 pb-20">
              <header className="bg-white border-b border-gray-200 sticky top-0 z-20">
                <div className="max-w-2xl mx-auto px-4 h-12 flex items-center justify-between">
                    <div className="flex items-center gap-2">
                        <Wallet className="w-5 h-5 text-slate-700" />
                        <h1 className="text-base font-bold text-slate-800">
                            家計支払いリスト
                        </h1>
                    </div>
                    <div className="flex items-center gap-3">
                        <input 
                            type="file" 
                            ref={fileInputRef} 
                            onChange={handleFileChange} 
                            className="hidden" 
                        />
                        <button onClick={handleRestoreClick} className="text-slate-500 hover:text-slate-800 transition-colors" title="復元">
                            <Upload className="w-5 h-5" />
                        </button>
                        <button onClick={handleBackup} className="text-slate-500 hover:text-slate-800 transition-colors" title="バックアップ">
                            <Download className="w-5 h-5" />
                        </button>
                    </div>
                </div>
              </header>

              <main className="max-w-2xl mx-auto px-4 py-3 space-y-2">
                <section>
                  <TransactionForm onAdd={handleAddTransaction} />
                </section>
                <StatsCard amount={totalUnpaid} />
                <section>
                  <div className="flex items-center justify-between mb-1 px-1">
                    <h2 className="text-xs font-bold text-slate-500">リスト</h2>
                    <span className="text-xs text-slate-400">{transactions.length}件</span>
                  </div>
                  <TransactionList 
                    transactions={sortedTransactions} 
                    onDelete={handleDeleteTransaction}
                    onToggleStatus={handleToggleStatus}
                  />
                </section>
              </main>
            </div>
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
